import { Callout } from 'components'
import { Tab, Tabs } from 'nextra-theme-docs'

# Use Freebets

To use a freebet, the user needs:

1. See available freebet list (fetched from the azuro api) in the UI.
2. Create a bet with selected freebet.
3. Claim winnings.

## Fetch available freebets

<Tabs items={[ 'SDK', 'Toolkit', 'Manual' ]}>
  <Tab>
    1. To retrieve all user's `bonuses` use the [`useBonuses`](/hub/apps/sdk/bonus/useBonuses) hook:

    ```tsx copy
    'use client'

    import { useBonuses } from '@azuro-org/sdk'
    import { BonusStatus } from '@azuro-org/toolkit'
    import { useAccount } from 'wagmi'


    const NewFreeBetsChecker: React.FC = () => {
      const { address } = useAccount()

      const { data: bonuses } = useBonuses({
        account: address!,
        affiliate: '0x...', // your affiliate address
        query: {
          enabled: Boolean(address),
        },
      })

      const activeFreebets = bonuses?.filter((freebet) => {
        return freebet.status === BonusStatus.Available
      })

      return (
        // render freebets
      )
    }
    ```

    2. To get all `freebets` that can be used based on the provided bet information (`selections`) use the [`useAvailableFreebets`](/hub/apps/sdk/bonus/useAvailableFreebets) hook:

    ```tsx copy
    'use client'

    import { useAvailableFreebets } from '@azuro-org/sdk'
    import { useAccount } from 'wagmi'


    const AvailableFreebets: React.FC = () => {
      const { address } = useAccount()

      const items = [...] // your stored betslip items

      const { data: freebets } = useAvailableFreebets({
        account: address!,
        affiliate: '0x...', // your affiliate address
        selections: items,
        query: {
          enabled: Boolean(address),
        },
      })

      return (
        // render available freebets
      )
    }
    ```

    <Callout type="info">
      Using [`BetslipProvider`](/hub/apps/sdk/providers/betslip):

      ```tsx copy
      import { useDetailedBetslip } from '@azuro-org/sdk'

      const SelectFreebet: React.FC = () => {
        const { 
          freebets, selectedFreebet, selectFreebet, 
          isFreebetsFetching,
        } = useDetailedBetslip()

        // select specific freebet
        const handleClick = () => {
          selectFreebet(freebets[0])
        }

        return (
          // render available freebets
        )
      }
      ```
    </Callout>
    
  </Tab>
  <Tab>
    1. To retrieve all user's `bonuses` use the [`getBonuses`](/hub/apps/toolkit/bonus/getBonuses) function:

    ```ts
    import { getBonuses } from '@azuro-org/toolkit'

    const bonuses = await getBonuses({
      chainId: 137
      account: '0x...' // user's address
      affiliate: '0x...' // your affiliate address
    })
    ```

    2. To get all `freebets` that can be used based on the provided bet information (`selections`) use the [`getAvailableFreebets`](/hub/apps/toolkit/bonus/getAvailableFreebets) function:

    ```ts
    import { getAvailableFreebets } from '@azuro-org/toolkit'

    const freebets = await getAvailableFreebets({
      chainId: 137
      account: '0x...' // user's address
      affiliate: '0x...' // your affiliate address
      selections: [{...}]
    })
    ```
  </Tab>
  <Tab>
    1. To retrieve all user's `bonuses` use the [Bonus Public API](https://dev-api.onchainfeed.org/api/v1/public/gateway/docs#/Bonus%20Public/BonusPublicController_getBonusesByAddresses):

    ```ts
    type Bonus = {
      id: string
      bonusType: BonusType
      freebetParam: {
        isBetSponsored: true,
        isFeeSponsored: true,
        isSponsoredBetReturnable: true
      },
      address: string
      amount: string
      status: BonusStatus
      network: string
      currency: string
      expiresAt: string
      usedAt: string
      createdAt: string
    }

    type GetBonusesResponse = {
      bonuses: Bonus[]
    }

    const api = 'https://dev-api.onchainfeed.org/api/v1/public' // development
    const api = 'https://api.onchainfeed.org/api/v1/public' // production

    const account = '0x...' // user's address
    const affiliate = '0x...' // affiliate address

    const response = await fetch(`${api}/bonus/get-by-addresses`, {
      method: 'POST',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        bettorAddress: account,
        poolAddress: affiliate,
      }),
    })

    if (!response.ok) {
      throw new Error(`Status ${response.status}: ${response.statusText}`)
    }

    const { bonuses }: GetBonusesResponse = await response.json()
    ```

    2. To get all `freebets` that can be used based on the provided bet information (`selections`) use the [Bonus Public API](https://dev-api.onchainfeed.org/api/v1/public/gateway/docs#/Bonus%20Public/BonusPublicController_getBonusesByAddresses):


    ```ts
    export type GetFreebetsResponse = {
      bonuses: Bonus[]
    }

    enum Environment {
      GnosisDevXDAI = 'GnosisDevXDAI',
      GnosisXDAI = 'GnosisXDAI',
      PolygonUSDT = 'PolygonUSDT',
      PolygonAmoyUSDT = 'PolygonAmoyUSDT',
      ChilizWCHZ = 'ChilizWCHZ',
      ChilizSpicyWCHZ = 'ChilizSpicyWCHZ',
      BaseWETH = 'BaseWETH',
      BaseSepoliaWETH = 'BaseSepoliaWETH'
    }

    const api = 'https://dev-api.onchainfeed.org/api/v1/public' // development
    const api = 'https://api.onchainfeed.org/api/v1/public' // production

    const environment = Environment.PolygonUSDT
    const account = '0x...' // user's address
    const affiliate = '0x...' // affiliate address
    const selections = [{
      conditionId: '123',
      outcomeId: 123
    }]

    const response = await fetch(`${api}/bonus/freebet/get-available`, {
      method: 'POST',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        environment,
        bettorAddress: account,
        poolAddress: affiliate,
        selections,
      }),
    })

    if (!response.ok) {
      throw new Error(`Status ${response.status}: ${response.statusText}`)
    }

    const { bonuses }: GetFreebetsResponse = await response.json()
    ```
  </Tab>
</Tabs>

## Use freebet to place a bet

<Tabs items={[ 'SDK', 'Toolkit', 'Manual' ]}>
  <Tab>
    Pass selected freebet to the [`useBet`](/hub/apps/sdk/write-hooks/useBet) hook:

    ```tsx copy
    const BetButton: React.FC<BetButtonProps> = () => {
      const { items, clear } = useBaseBetslip()
      const { selectedFreebet } = useDetailedBetslip()

      const { submit } = useBet({
        ..., // other props
        freebet: selectedFreebet,
      })

      return (
        <button onClick={submit}>Bet</button>
      )
    }
    ```
  </Tab>
  <Tab>
    ```ts
    const freebet: Freebet = {...}

    const betData = {
      account: account.address!,
      clientData: {
        attention: '', // attention text
        affiliate: '0x...', // your affiliate address
        core: '0x...', // core address
        expiresAt, // bet expired date
        chainId: appChain.id,
        relayerFeeAmount: String(rawRelayerFeeAmount),
        isBetSponsored: freebet?.params?.isBetSponsored || false,
        isFeeSponsored: freebet?.params?.isFeeSponsored || false,
        isSponsoredBetReturnable: freebet?.params?.isSponsoredBetReturnable || false,
      },
      bet: {
        conditionId: conditionId,
        outcomeId,
        amount: rawAmount,
        minOdds: rawMinOdds,
        nonce: String(Date.now()),
      },
    }

    // create typed data for signatire
    const typedData = getBetTypedData(betData)

    // sign typed data with your wallet client
    const signature = await walletClient!.data!.signTypedData(typedData)


    const createdOrder = await createBet({
      ...betData,
      bonusId: freebet?.id,
      signature,
    })

    const {
      id: orderId,
      state: newOrderState,
      errorMessage,
    } = createdOrder!
    ```
  </Tab>
</Tabs>

<br></br>
<br></br>
<br></br>
<br></br>
<br></br>
Use the [Azuro Freebets API](https://api.azuro.org/api/v1/public/freebets/docs/static/index.html) to get info about new freebets distributed for the customers.

```ts copy
type Address = `0x${string}`
type Hex = `0x${string}`

enum RestFreebetStatus {
  New = 'New',
  Claimed = 'Claimed',
  Redeemed = 'Redeemed',
  Canceled = 'Canceled',
  Reissued = 'Reissued',
  Withdrawn = 'Withdrawn',
}

type RestFreebet = {
  id: number
  owner: Address
  amount: string // raw '10000000'
  minOdds: string // raw '10000000'
  contractId: number
  signature: Hex
  expiresAt: number // unix timestamp in seconds
  campaign: string
  status: RestFreebetStatus
  contract: {
    id: number
    affiliate: Address
    chainId: string
    freebetContractAddress: Address
    decimals: number
  }
}

const freebetFetcher = async (bettorAddress: string): Promise<RestFreebet[]> => {
  const response = await axios.get<RestFreebet[]>('https://api.azuro.org/api/v1/public/freebets/list', {
    params: {
      owner: bettorAddress.toLowerCase(),
      affiliate: '0x...', // your affiliate address
    },
  })

  return response.data || []
}
```

Api returns all available to claim freebets for specified bettor (status: `New` | `Reissued`).

<Callout type="warning">
  If you work in several chains, pay attention to handle it, api returns all available freebets from all supported chains.
  You must validate that `freebet.contract.chainId` is the same as current app chain before suggesting to use it for a bet.
  Also validate that odds of selected outcome (including slippage) satisfies `freebet.minOdds`.
</Callout>

<Callout type="alert">
  Freebets are not acceptable for combo bets.
</Callout>

## Use freebet to place a bet

If you're not familiar with generic logic around placing a bet, please read [Guides section](/hub/apps/guides/advanced/prematch/place-a-bet) first.

<Callout type="warning">
  To apply freebet, `outcome.rawMinOdds` should be greater than `freebet.minOdds`. The bet should be single - freebets aren't applicable to combo bets.
</Callout>

<Callout type="warning">
  Please note that we provide you with the flexibility to distribute Freebets without a budget limitation.
  However, if your customers claim Freebets for an amount exceeding the freebet contract balance,
  they will encounter an error during the smart contract execution call.
</Callout>

<Tabs items={[ 'Ethers', 'Wagmi' ]}>
<Tab>
```ts
import { ethers } from 'ethers'

if (BigInt(outcome.rawMinOdds) <  BigInt(freebet.minOdds)) {
  // outcome minOdds should be greater than freebet.minOdds
  return
}

const data = ethers.utils.defaultAbiCoder.encode(
  [ 'tuple(uint256, uint64)' ],
  [ { conditionId, outcomeId } ]
)

const freebetContract = new Contract(freebet.contract.freebetContractAddress, freebetABI)

freebetContract.bet(
  {
    chainId: freebet.contract.chainId,
    expiresAt: freebet.expiresAt,
    amount: freebet.amount,
    freeBetId: freebet.id,
    minOdds: freebet.minOdds,
    owner: account,
  },
  freebet.signature,
  coreAddress,
  conditionId,
  outcomeId,
  deadline,
  outcome.rawMinOdds
)
```
</Tab>
<Tab>
```ts
import { useContractWrite, encodeAbiParameters } from 'wagmi'

if (BigInt(outcome.rawMinOdds) <  BigInt(freebet.minOdds)) {
  // outcome minOdds should be greater than freebet.minOdds
  return
}

const data = encodeAbiParameters(
  parseAbiParameters('uint256, uint64'),
  [
    BigInt(conditionId),
    BigInt(outcomeId),
  ]
)

useContractWrite({
  address: freebet.contract.freebetContractAddress,
  abi: freebetABI,
  functionName: 'bet',
  args: [
    {
      chainId: freebet.contract.chainId,
      expiresAt: freebet.expiresAt,
      amount: freebet.amount,
      freeBetId: freebet.id,
      minOdds: freebet.minOdds,
      owner: account,
    },
    freebet.signature,
    coreAddress,
    BigInt(conditionId),
    BigInt(outcomeId),
    BigInt(deadline),
    outcome.rawMinOdds
  ],
})
```
</Tab>
</Tabs>


## Withdraw a winning freebet

When customer placed a freebet, it will become regular bet in their bet history.
<Callout type="info">
  The customer will only receive profit from the bet: `bet.payout - bet.amount`, the body of bet (amount) will be returned to the freebet contract
</Callout>
To redeem a winning freebet, you should call freebet contract:
```ts
const freebetContract = new Contract(bet.freebet.freebetContractAddress, freebetABI)

const tx = await freebetContract.connect(signer).withdrawPayout(bet.freebet.freebetId)
```

All details about bet history and base logic of redeem, please read in Guides section:
[Bet history](/hub/apps/guides/advanced/prematch/get-bets-history) & [Redeem Bets](/hub/apps/guides/advanced/prematch/redeem-bets)
